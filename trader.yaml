template:
  - sensor:
    - unique_id: my_max_grid_export
      default_entity_id: sensor.my_max_grid_export
      name: Max Grid Exports
      state: 30

    - unique_id: my_amber_buy_price_sensor
      default_entity_id: sensor.my_amber_buy_price_sensor
      name: "My Amber Buy Price Sensor"
      state: "sensor.amber_true_five_min_price_mqtt"
      attributes:
        multiplier: "1"

    - unique_id: my_amber_sell_price_sensor
      default_entity_id: sensor.my_amber_sell_price_sensor
      name: "My Amber Sell Price Sensor" 
      state: "sensor.amber_true_five_minute_export_price"  
      attributes:
          multiplier: "1"

    - unique_id: my_curtailed_solar_sensor
      default_entity_id: sensor.my_curtailed_solar_sensor
      name: "My Curtailed Solar Sensor"
      state: "number.potentially_curtailed_pv_kw"

    - unique_id: trader_curtailed_solar_estimate
      unit_of_measurement: kW
      device_class: power
      default_entity_id: sensor.trader_curtailed_solar_estimate
      icon: mdi:solar-power
      name: Curtailed solar estimate
      state: "{% set curtailed = states(states('sensor.my_curtailed_solar_sensor'))|float(default=-0.1) %}
          {{ curtailed }}"


    - unique_id: trader_cheapest_buy_price
      unit_of_measurement: cents
      device_class: monetary
      default_entity_id: sensor.trader_cheapest_buy_price
      icon: mdi:cash
      name: Lowest active battery sell price
      state: "{% set price = states('sensor.trader_sell_price') | float(default=0) %}
        {% set soc = states('sensor.sigen_inverter_battery_state_of_charge') | float(default=0) %}
        {% set ns = namespace(pick=0) %}
        {% for l in ['e', 'd', 'c', 'b', 'a'] %}
          {% set stop_at_soc = states('input_number.trader_soc_sell_to_' + l) | float(default=50) %}
          {% set want_price = states('input_number.trader_sell_price_' + l) | float(default=999) %}
          {% set enabled = is_state('input_boolean.trader_sell_enabled_' + l, 'on') %}
          {% if enabled and  soc > stop_at_soc %}
            {% set ns.pick = want_price %}
            {% break %}
          {% endif %}
        {% endfor %}
        {{ ns.pick }}"

    - unique_id: trader_plan_letter
      default_entity_id: sensor.trader_plan_letter
      name: Active plan
      state: "{% set price = states('sensor.trader_sell_price')| float(0) %}
          {% set soc = states('sensor.sigen_inverter_battery_state_of_charge') | float(default=0) %}
          {% set ns = namespace(pick='z') %}
          {% for l in ['a', 'b', 'c', 'd', 'e'] %}
            {% set stop_at_soc = states('input_number.trader_soc_sell_to_' + l) | float(default=50) %}
            {% set want_price = states('input_number.trader_sell_price_' + l) | float(default=9999) %}
            {% set enabled = is_state('input_boolean.trader_sell_enabled_' + l, 'on') %}
            {% if enabled and price >= want_price and soc > stop_at_soc %}
              {% set ns.pick = l %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ ns.pick }}"


    - unique_id: trader_battery_discharge_rate_chosen_from_plan
      unit_of_measurement: kW
      default_entity_id: sensor.trader_battery_discharge_rate_chosen_from_plan
      icon: mdi:transmission-tower-export
      name: Export discharge rate based on plan
      state: "{% set option_letter = states('sensor.trader_plan_letter') %}
        {% set entity_id = 'input_number.trader_export_rate_' + option_letter %}
        {% set new_kw = states(entity_id) | float(default=0) %}
        {% set spare_solar = states('sensor.trader_spare_solar') | float(default=0) %}
        {% set enabled = is_state('input_boolean.trader_increase_export_rate_by_solar', 'on') %}
        {% set positive_fit = is_state('binary_sensor.trader_sell_price_is_negative', 'off') %}
        {% if enabled and positive_fit %}
          {% set limit = (new_kw + spare_solar) | float | round(2) %}
        {% else %}
          {% set limit = new_kw | float | round (2) %}
        {% endif %}
        {{limit | float}}"


    - unique_id: trader_spare_solar
      unit_of_measurement: kW
      device_class: power
      default_entity_id: sensor.trader_spare_solar
      icon: mdi:solar-power
      name: Current spare solar
      state: "{% set curtailed = states('sensor.trader_curtailed_solar_estimate')|float(default=-0.1) %}
          {% set pv_kw = states('sensor.sigen_plant_pv_power') | float(default=0) %}
          {% set plant_active_kw = states('sensor.sigen_plant_plant_active_power') | float(default=0) %}
          {% set grid_sensor_kw = states('sensor.sigen_plant_grid_active_power') | float(default=0) %}
          {% set spare = pv_kw - plant_active_kw %}
          {% if grid_sensor_kw < 0 %}
            {% set spare = spare - grid_sensor_kw %}
          {% endif %}
          {%  if spare < 0 %}
            {% set spare = 0 %}
          {% endif %}
          {% if curtailed > 0 %}
            {% set spare = spare + curtailed %}
          {% elif spare > pv_kw %}
            {% set spare = pv_kw %}
          {% endif %}
          {{ spare | round(1) }}"


    - unique_id: trader_stop_at_soc
      unit_of_measurement: '%'
      device_class: battery
      default_entity_id: sensor.trader_stop_at_soc
      icon: mdi:percent
      name: Export discharge SOC based on plan
      state: "{% set option_letter = states('sensor.trader_plan_letter')  %}
          {{ states('input_number.trader_soc_sell_to_' + option_letter) | int(default=0) }}"


    - unique_id: trader_buy_price
      unit_of_measurement: cents
      device_class: monetary
      default_entity_id: sensor.trader_buy_price
      icon: mdi:cash
      name: Amber buy price
      state: "{% set mult = state_attr('sensor.my_amber_buy_price_sensor', 'multiplier') |int(1) %}
          {{ states(states('sensor.my_amber_buy_price_sensor')) | float(default=999) * mult }}"

    - unique_id: trader_sell_price
      unit_of_measurement: cents
      device_class: monetary
      default_entity_id: sensor.trader_sell_price
      icon: mdi:cash-refund
      name: Amber sell price
      state: "{% set mult = state_attr('sensor.my_amber_buy_price_sensor', 'multiplier') | int(1) %}
          {{ states(states('sensor.my_amber_sell_price_sensor'))| float(default=-999) * mult }}"


    - unique_id: trader_preferred_mode
      default_entity_id: sensor.trader_mode
      name: Preferred mode
      state: "
          {% set negative_buy = is_state('binary_sensor.trader_buy_price_is_negative', 'on') %}
          {% set force_charge = is_state('input_boolean.trader_force_charge', 'on') %}
          {% if is_state('binary_sensor.trader_exporting_criteria_met', 'on') %}
          Command Discharging (PV First)
          {% else %}
            {% if negative_buy %}
          Command Charging (Grid First)
           {% elif force_charge %}
          Command Charging (PV First)
            {% else %}
          Maximum Self Consumption
            {% endif %}
          {% endif %}"



  - binary_sensor:

    - unique_id: trader_buy_price_is_negative
      default_entity_id: binary_sensor.trader_buy_price_is_negative
      name: Grid buy price is negative
      state: "{% set price = states('sensor.trader_buy_price')|float(0) %}
        {{ price <0 }}"


    - unique_id: trader_exporting_criteria_met
      default_entity_id: binary_sensor.trader_exporting_criteria_met
      name: Exporting criteria met
      state: "{% if is_state('input_boolean.trader_enable_auto_selling_from_battery','on') and states('sensor.trader_plan_letter')  != 'z' %}
            true
          {% else %}
            false
          {% endif %}"


    - unique_id: trader_sell_price_is_negative
      default_entity_id: binary_sensor.trader_sell_price_is_negative
      name: Grid sell price is negative
      state: "{% set price = states('sensor.trader_sell_price')|float(0) %}
          {{ price <0 }}"


    - unique_id: trader_solar_divert_conditions_met
      default_entity_id: binary_sensor.trader_solar_divert_conditions_met
      name: Divert solar to grid conditions met
      state: "{{ is_state('sensor.sigen_plant_grid_connection_status','On Grid') and states('sensor.trader_sell_price')|float(0) > states('input_number.trader_solar_divert_sell_price')|float(99)
             and is_state('input_boolean.trader_divert_solar_enabled', 'on') and is_state('binary_sensor.trader_sell_price_is_negative','off') }}"

    - unique_id: trader_charge_from_grid_price_met
      default_entity_id: binary_sensor.trader_charge_from_grid_price_met
      name: Charge battery from grid price met
      state: "{{ states('sensor.trader_buy_price')|float(999) < states('input_number.trader_charge_from_grid_price')|float(0) }}"
        

    - unique_id: trader_use_cheap_grid_not_battery
      default_entity_id: binary_sensor.trader_use_cheap_grid_not_battery
      name: Use Cheap Grid instead of from battery
      state: "{% set max_price = states('input_number.trader_prefer_grid_priced_under')|float(0) %}
          {% set price_now = states('sensor.trader_buy_price')|float(9999) %}
          {% set soc = states('sensor.sigen_plant_battery_state_of_charge')|int %}
          {{ price_now < max_price }} "


input_number:
#####################
# Sell price triggers
#####################
  trader_sell_price_a:
    name: Battery sell price A
    <<: &shared1
      min: -999
      max: 25000
      step: 1
      mode: box
      unit_of_measurement: cents
      icon: 'mdi:currency-usd'
  
  trader_sell_price_b:
    name: Battery sell price B
    <<: *shared1
    
  trader_sell_price_c:
    name: Battery sell price C
    <<: *shared1
          
  trader_sell_price_d:
    name: Battery sell price D
    <<: *shared1
    
  trader_sell_price_e:
    name: Battery sell price E
    <<: *shared1

  trader_sell_price_z:
    name: Battery sell price Z
    <<: *shared1

  trader_solar_divert_sell_price:
    name: Min Solar price to divert to grid
    <<: *shared1

  trader_prefer_grid_priced_under:
    name: Prefer Grid over Battery Priced Under
    <<: *shared1

  trader_charge_from_grid_price:
    name: Charge Battery From Grid Price
    initial: 0
    <<: *shared1


#####################
# Sell SOC minima
#####################

  trader_soc_sell_to_a:
    name: Battery sell soc A
    <<: &shared2
      min: 0
      max: 100
      step: 1
      mode: box
      unit_of_measurement: "%"
      icon: 'mdi:battery-20'

  trader_soc_sell_to_b:
    name: Battery sell soc B
    <<: *shared2
    
  trader_soc_sell_to_c:
    name: Battery sell soc C
    <<: *shared2
    
  trader_soc_sell_to_d:
    name: Battery sell soc D
    <<: *shared2
    
  trader_soc_sell_to_e:
    name: Battery sell soc E
    <<: *shared2
  
  trader_soc_sell_to_z:
    name: Battery sell soc Z
    <<: *shared2

#####################
# Sell price rates (kW)
#####################

  trader_export_rate_a:
    name: Battery sell rate A
    <<: &shared3
      min: 0
      max: 100
      step: 1
      mode: box
      unit_of_measurement: kW
      icon: 'mdi:flash'
    
  trader_export_rate_b:
    name: Battery sell rate B
    <<: *shared3

  trader_export_rate_c:
    name: Battery sell rate C
    <<: *shared3
    
  trader_export_rate_d:
    name: Battery sell rate D
    <<: *shared3
    
  trader_export_rate_e:
    name: Battery sell rate E
    <<: *shared3

  trader_export_rate_z:
    name: Battery sell rate Z
    <<: *shared3

############
# helpers to implement upper and lower battery SOC levels to implement battery preservation
############

  trader_battery_preserve_upper_soc:
    name: Battery Preserve Up To SOC
    <<: &shared4
      min: 0
      max: 100
      step: 1
      mode: box
      unit_of_measurement: '%'
      icon: 'mdi:percent'

  trader_battery_preserve_lower_soc:
    name: Battery Preserve Down To SOC
    <<: *shared4

  trader_battery_default_charge_to_soc:
    name: Battery Default Charge To SOC
    <<: *shared4

  trader_battery_default_discharge_to_soc:
    name: Battery Default Discharge To SOC
    <<: *shared4

###########
# helpers to store 5m and 30m import and export costs/earnings
#  requires an automation to run every 5m to update costs.
###########

  trader_last_exports_lifetime:
    name: Last exports lifetime
    <<: &shared7
      unit_of_measurement: KWh
      mode: box
      max: 9999999
      min: 0

  trader_last_imports_lifetime:
    name: Last imports lifetime
    <<: *shared7

  trader_last_exports_energy:
    name: Last exports energy
    <<: *shared7

  trader_last_imports_energy:
    name: Last imports energy  
    <<: *shared7

  trader_last_5m_imports_cost:
    name: Last 5m imports cost
    <<: &shared5
      unit_of_measurement: cents
      mode: box
      initial: 0
      max: 10000
      min: -1000

  trader_last_5m_exports_earnings:
    name: Last 5m exports earnings
    <<: *shared5

  trader_last_30m_imports_cost:
    name: Last 30m imports cost
    <<: &shared6
      unit_of_measurement: cents
      mode: box
      initial: 0
      max: 60000
      min: -6000

  trader_last_30m_exports_earnings:
    name: Last 30m exports earnings  
    <<: *shared6

  trader_last_30m_imports_running_cost:
    name: Last 30m imports running cost  
    <<: *shared6

  trader_last_30m_exports_running_earnings:
    name: Last 30m exports running earnings  
    <<: *shared6


#####################
# On/off settings
#####################

input_boolean:

  trader_sell_enabled_a:
    name: Battery sell enabled A
  trader_sell_enabled_b:
    name: Battery sell enabled B
  trader_sell_enabled_c:
    name: Battery sell enabled C
  trader_sell_enabled_d:
    name: Battery sell enabled D
  trader_sell_enabled_e:
    name: Battery sell enabled E

  trader_divert_solar_enabled:
    name: Divert solar to grid enabled

  trader_increase_export_rate_by_solar:
    name: Increase export rate with spare solar
  trader_enable_auto_change_export_limit:
    name: Enable Export Limit Changes
  trader_enable_auto_selling_from_battery:
    name: Enable Exports

  trader_toggle_plans_section_visibility_on_dashboard:
    name: Toggle Plans Visibility

  trader_toggle_preserve_section_visibility_on_dashboard:
    name: Toggle Preserve Visibility    

  trader_enable_high_battery_preserve:
    name: Enable High Battery Preserve

  trader_enable_low_battery_preserve:
    name: Enable Low Battery Preserve

  trader_force_charge:
    name: Force Charge


